name: Deploy to Server

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging

env:
  REGISTRY: ghcr.io
  IMAGE_PREFIX: ${{ github.repository_owner }}/chillax

jobs:
  deploy:
    runs-on: ubuntu-latest
    if: ${{ github.event_name == 'workflow_dispatch' }}
    environment: ${{ github.event.inputs.environment || 'production' }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '10.0.x'

      - name: Install Aspire CLI
        run: dotnet tool install --global aspire.cli --prerelease

      - name: Generate Docker Compose artifacts
        env:
          Parameters__postgres_password: postgres
          Parameters__eventbus_password: guest
          Parameters__keycloak_password: admin
        run: |
          cd src/Chillax.AppHost
          aspire publish -o ../../deploy-artifacts

      - name: Prepare deployment artifacts
        run: |
          cp src/Chillax.AppHost/KeycloakConfiguration/chillax-realm.json deploy-artifacts/chillax-realm.json
          sed -i 's|source: ".*chillax-realm.json"|source: "./chillax-realm.json"|g' deploy-artifacts/docker-compose.yaml
          sed -i 's|target: "/opt/keycloak/data/import"|target: "/opt/keycloak/data/import/chillax-realm.json"|g' deploy-artifacts/docker-compose.yaml

          # Fill empty .env values (aspire publish generates empty placeholders)
          sed -i 's/^POSTGRES_PASSWORD=$/POSTGRES_PASSWORD=postgres/' deploy-artifacts/.env
          sed -i 's/^EVENTBUS_PASSWORD=$/EVENTBUS_PASSWORD=guest/' deploy-artifacts/.env
          sed -i 's/^KEYCLOAK_PASSWORD=$/KEYCLOAK_PASSWORD=admin/' deploy-artifacts/.env

          # Fill port values for service discovery
          sed -i 's/^CATALOG_API_PORT=$/CATALOG_API_PORT=8080/' deploy-artifacts/.env
          sed -i 's/^ORDERING_API_PORT=$/ORDERING_API_PORT=8080/' deploy-artifacts/.env
          sed -i 's/^ROOMS_API_PORT=$/ROOMS_API_PORT=8080/' deploy-artifacts/.env
          sed -i 's/^IDENTITY_API_PORT=$/IDENTITY_API_PORT=8080/' deploy-artifacts/.env
          sed -i 's/^LOYALTY_API_PORT=$/LOYALTY_API_PORT=8080/' deploy-artifacts/.env
          sed -i 's/^NOTIFICATION_API_PORT=$/NOTIFICATION_API_PORT=8080/' deploy-artifacts/.env
          sed -i 's/^ACCOUNTS_API_PORT=$/ACCOUNTS_API_PORT=8080/' deploy-artifacts/.env

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: deploy-artifacts
          path: deploy-artifacts/

      - name: Copy deployment files to server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          source: "deploy-artifacts/*"
          target: ${{ secrets.DEPLOY_PATH }}
          strip_components: 1

      - name: Deploy to server
        uses: appleboy/ssh-action@v1
        env:
          GHCR_TOKEN: ${{ secrets.GHCR_TOKEN }}
          GHCR_USER: ${{ github.actor }}
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          envs: GHCR_TOKEN,GHCR_USER
          script: |
            cd ${{ secrets.DEPLOY_PATH }}

            # Login to GHCR
            echo "$GHCR_TOKEN" | docker login ghcr.io -u "$GHCR_USER" --password-stdin

            # Pull pre-built images and build any Aspire-generated services (e.g. mobile-bff)
            docker compose pull --ignore-buildable
            docker compose up -d --build --remove-orphans

            # Cleanup old images
            docker image prune -f

            # Show running containers
            docker compose ps

      - name: Setup Keycloak token exchange
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          command_timeout: 10m
          script: |
            set -e

            DEPLOY_DIR="${{ secrets.DEPLOY_PATH }}"
            REALM="chillax"
            CLIENT_ID="mobile-app"
            KC="/opt/keycloak/bin/kcadm.sh"

            # Find the keycloak container
            CONTAINER=$(docker compose -f "$DEPLOY_DIR/docker-compose.yaml" ps -q keycloak 2>/dev/null || docker compose -f "$DEPLOY_DIR/docker-compose.yml" ps -q keycloak 2>/dev/null)
            if [ -z "$CONTAINER" ]; then
              echo "ERROR: Keycloak container not found"
              exit 1
            fi
            echo "Keycloak container: $CONTAINER"

            # Read admin password from deploy .env
            KC_PASSWORD=$(grep -oP '^KEYCLOAK_PASSWORD=\K.*' "$DEPLOY_DIR/.env" 2>/dev/null || echo "admin")

            # Wait for Keycloak to be ready
            echo "Waiting for Keycloak to be ready..."
            for i in $(seq 1 30); do
              if docker exec "$CONTAINER" $KC config credentials \
                --server http://localhost:8080 --realm master --user admin --password "$KC_PASSWORD" > /dev/null 2>&1; then
                echo "  Keycloak is ready and authenticated"
                break
              fi
              if [ "$i" -eq 30 ]; then
                echo "ERROR: Keycloak not ready after 30 attempts"
                exit 1
              fi
              echo "  Attempt $i/30 - waiting 5s..."
              sleep 5
            done

            echo ""
            echo "=== Enable permissions on identity providers ==="
            for IDP_ALIAS in google apple; do
              echo "Enabling permissions for $IDP_ALIAS..."
              docker exec "$CONTAINER" $KC update "identity-provider/instances/$IDP_ALIAS/management/permissions" \
                -r $REALM -s enabled=true 2>/dev/null && \
                echo "  Permissions enabled for $IDP_ALIAS" || \
                echo "  Permissions already enabled or IdP not found for $IDP_ALIAS"
            done

            echo ""
            echo "=== Get realm-management and mobile-app client IDs ==="
            REALM_MGMT_ID=$(docker exec "$CONTAINER" $KC get clients \
              -r $REALM --fields id,clientId | \
              python3 -c "import sys,json; clients=json.load(sys.stdin); print(next(c['id'] for c in clients if c['clientId']=='realm-management'))")
            echo "  realm-management ID: $REALM_MGMT_ID"

            MOBILE_APP_ID=$(docker exec "$CONTAINER" $KC get clients \
              -r $REALM --fields id,clientId | \
              python3 -c "import sys,json; clients=json.load(sys.stdin); print(next(c['id'] for c in clients if c['clientId']=='$CLIENT_ID'))")
            echo "  mobile-app ID: $MOBILE_APP_ID"

            echo ""
            echo "=== Get or create mobile-app-policy ==="
            POLICY_ID=$(docker exec "$CONTAINER" $KC get \
              "clients/$REALM_MGMT_ID/authz/resource-server/policy/client" \
              -r $REALM --fields id,name 2>/dev/null | \
              python3 -c "
            import sys,json
            try:
              policies=json.load(sys.stdin)
              print(next(p['id'] for p in policies if p['name']=='mobile-app-policy'))
            except:
              print('')
            " 2>/dev/null || true)

            if [ -n "$POLICY_ID" ]; then
              echo "  Policy already exists: $POLICY_ID (skipping creation)"
            else
              echo "  Creating new client policy..."
              docker exec "$CONTAINER" $KC create \
                "clients/$REALM_MGMT_ID/authz/resource-server/policy/client" \
                -r $REALM \
                -s name=mobile-app-policy \
                -s description="Allow mobile-app client for token exchange" \
                -s logic=POSITIVE \
                -s "clients=[\"$MOBILE_APP_ID\"]"

              POLICY_ID=$(docker exec "$CONTAINER" $KC get \
                "clients/$REALM_MGMT_ID/authz/resource-server/policy/client" \
                -r $REALM --fields id,name | \
                python3 -c "
            import sys,json
            policies=json.load(sys.stdin)
            print(next(p['id'] for p in policies if p['name']=='mobile-app-policy'))
            ")
              echo "  Created policy: $POLICY_ID"
            fi

            echo ""
            echo "=== Assign policy to token-exchange permissions ==="
            for IDP_ALIAS in google apple; do
              # Query each IdP's permissions endpoint to get the exact permission ID
              PERM_ID=$(docker exec "$CONTAINER" $KC get \
                "identity-provider/instances/$IDP_ALIAS/management/permissions" \
                -r $REALM 2>/dev/null | \
                python3 -c "
            import sys,json
            try:
              data=json.load(sys.stdin)
              scopes = data.get('scopePermissions', {})
              print(scopes.get('token-exchange', ''))
            except:
              print('')
            " 2>/dev/null || true)

              if [ -n "$PERM_ID" ]; then
                echo "  Updating token-exchange permission for $IDP_ALIAS ($PERM_ID)..."
                docker exec "$CONTAINER" $KC update \
                  "clients/$REALM_MGMT_ID/authz/resource-server/permission/scope/$PERM_ID" \
                  -r $REALM \
                  -s "policies=[\"$POLICY_ID\"]" \
                  -s decisionStrategy=AFFIRMATIVE 2>/dev/null && \
                  echo "    Done" || echo "    Failed to update permission"
              else
                echo "  No token-exchange permission found for $IDP_ALIAS"
              fi
            done

            echo ""
            echo "=== Keycloak token exchange setup complete ==="

  notify:
    runs-on: ubuntu-latest
    needs: deploy
    if: always()
    steps:
      - name: Notify deployment status
        run: |
          if [ "${{ needs.deploy.result }}" == "success" ]; then
            echo "Deployment successful!"
          else
            echo "Deployment failed!"
            exit 1
          fi
