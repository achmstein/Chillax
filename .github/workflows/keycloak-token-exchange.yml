name: Setup Keycloak Token Exchange

on:
  workflow_dispatch:

jobs:
  setup:
    runs-on: ubuntu-latest
    environment: production

    steps:
      - name: Setup token exchange permissions
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          script: |
            CONTAINER="chillax-keycloak-1"
            REALM="chillax"
            CLIENT_ID="mobile-app"
            KC="/opt/keycloak/bin/kcadm.sh"

            # Authenticate with Keycloak
            docker exec $CONTAINER $KC config credentials \
              --server http://localhost:8080 --realm master --user admin --password admin

            echo "=== Step 1: Enable permissions on identity providers ==="
            for IDP_ALIAS in google apple; do
              echo "Enabling permissions for $IDP_ALIAS..."
              docker exec $CONTAINER $KC update "identity-provider/instances/$IDP_ALIAS/management/permissions" \
                -r $REALM -s enabled=true 2>/dev/null && \
                echo "  Permissions enabled for $IDP_ALIAS" || \
                echo "  Permissions already enabled or IdP not found for $IDP_ALIAS"
            done

            echo ""
            echo "=== Step 2: Get realm-management client ID ==="
            REALM_MGMT_ID=$(docker exec $CONTAINER $KC get clients \
              -r $REALM --fields id,clientId | \
              python3 -c "import sys,json; clients=json.load(sys.stdin); print(next(c['id'] for c in clients if c['clientId']=='realm-management'))")
            echo "  realm-management ID: $REALM_MGMT_ID"

            echo ""
            echo "=== Step 3: Get mobile-app client ID ==="
            MOBILE_APP_ID=$(docker exec $CONTAINER $KC get clients \
              -r $REALM --fields id,clientId | \
              python3 -c "import sys,json; clients=json.load(sys.stdin); print(next(c['id'] for c in clients if c['clientId']=='$CLIENT_ID'))")
            echo "  mobile-app ID: $MOBILE_APP_ID"

            echo ""
            echo "=== Step 4: Create mobile-app-policy (client policy) ==="
            # Check if policy already exists
            EXISTING_POLICY=$(docker exec $CONTAINER $KC get \
              "clients/$REALM_MGMT_ID/authz/resource-server/policy/client" \
              -r $REALM --fields id,name 2>/dev/null | \
              python3 -c "
            import sys,json
            try:
              policies=json.load(sys.stdin)
              print(next(p['id'] for p in policies if p['name']=='mobile-app-policy'))
            except:
              print('')
            " 2>/dev/null)

            if [ -n "$EXISTING_POLICY" ]; then
              echo "  Policy already exists: $EXISTING_POLICY"
              POLICY_ID=$EXISTING_POLICY
            else
              echo "  Creating new client policy..."
              docker exec $CONTAINER $KC create \
                "clients/$REALM_MGMT_ID/authz/resource-server/policy/client" \
                -r $REALM \
                -s name=mobile-app-policy \
                -s description="Allow mobile-app client for token exchange" \
                -s logic=POSITIVE \
                -s "clients=[\"$MOBILE_APP_ID\"]" 2>/dev/null

              POLICY_ID=$(docker exec $CONTAINER $KC get \
                "clients/$REALM_MGMT_ID/authz/resource-server/policy/client" \
                -r $REALM --fields id,name | \
                python3 -c "
            import sys,json
            policies=json.load(sys.stdin)
            print(next(p['id'] for p in policies if p['name']=='mobile-app-policy'))
            ")
              echo "  Created policy: $POLICY_ID"
            fi

            echo ""
            echo "=== Step 5: Assign policy to token-exchange permissions ==="
            # Get all permissions and find token-exchange ones for each IdP
            PERMISSIONS=$(docker exec $CONTAINER $KC get \
              "clients/$REALM_MGMT_ID/authz/resource-server/permission" \
              -r $REALM --fields id,name 2>/dev/null)

            for IDP_ALIAS in google apple; do
              PERM_ID=$(echo "$PERMISSIONS" | python3 -c "
            import sys,json
            try:
              perms=json.load(sys.stdin)
              print(next(p['id'] for p in perms if 'token-exchange' in p.get('name','').lower() and '$IDP_ALIAS' in p.get('name','').lower()))
            except:
              print('')
            " 2>/dev/null)

              if [ -n "$PERM_ID" ]; then
                echo "  Updating token-exchange permission for $IDP_ALIAS ($PERM_ID)..."
                docker exec $CONTAINER $KC update \
                  "clients/$REALM_MGMT_ID/authz/resource-server/permission/scope/$PERM_ID" \
                  -r $REALM \
                  -s "policies=[\"$POLICY_ID\"]" \
                  -s decisionStrategy=AFFIRMATIVE 2>/dev/null && \
                  echo "    Done" || echo "    Failed to update permission"
              else
                echo "  No token-exchange permission found for $IDP_ALIAS (enable permissions first)"
              fi
            done

            echo ""
            echo "=== Setup complete ==="
