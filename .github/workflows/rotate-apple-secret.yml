name: Rotate Apple Client Secret

on:
  # Run every 5 months (day 1 at midnight)
  schedule:
    - cron: '0 0 1 */5 *'
  workflow_dispatch:

jobs:
  rotate:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Generate Apple client secret JWT
        id: generate
        env:
          APPLE_P8_KEY: ${{ secrets.APPLE_P8_KEY }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
          APPLE_SERVICE_ID: ${{ secrets.APPLE_SERVICE_ID }}
          APPLE_KEY_ID: ${{ secrets.APPLE_KEY_ID }}
        run: |
          SECRET=$(node deploy/rotate-apple-secret.js)
          echo "::add-mask::$SECRET"
          echo "secret=$SECRET" >> "$GITHUB_OUTPUT"

      - name: Update Keycloak Apple identity provider
        uses: appleboy/ssh-action@v1
        env:
          APPLE_SECRET: ${{ steps.generate.outputs.secret }}
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          envs: APPLE_SECRET
          script: |
            set -e

            DEPLOY_DIR="${{ secrets.DEPLOY_PATH }}"
            REALM="chillax"
            KC="/opt/keycloak/bin/kcadm.sh"

            # Find Keycloak container
            CONTAINER=$(docker compose -f "$DEPLOY_DIR/docker-compose.yaml" -f "$DEPLOY_DIR/docker-compose.caddy.yml" ps -q keycloak)
            if [ -z "$CONTAINER" ]; then
              echo "ERROR: Keycloak container not found"
              exit 1
            fi

            # Read admin password
            KC_PASSWORD=$(grep -oP '^KEYCLOAK_PASSWORD=\K.*' "$DEPLOY_DIR/.env" 2>/dev/null || echo "admin")

            # Authenticate
            docker exec "$CONTAINER" $KC config credentials \
              --server http://localhost:8080 --realm master --user admin --password "$KC_PASSWORD"

            # Update Apple IdP client secret
            docker exec "$CONTAINER" $KC update "identity-provider/instances/apple" \
              -r "$REALM" \
              -s "config.clientSecret=$APPLE_SECRET"

            echo "Apple client secret rotated successfully"
